kind: ConfigMap
apiVersion: v1
metadata:
  name: nginx-config
data:
  nginx.conf: |
    worker_processes  1;

    events {
      worker_connections  1024;
    }

    http {
      include       mime.types;
      default_type  application/octet-stream;

      server {
        listen 80 default_server;
        server_name  _;

        root /var/www/html;

        location / {
          try_files $uri $uri/ /index.php;
          if (!-e $request_filename) { rewrite ^(.*)$ /index.php last; }
        }

        location ~ \.php$ {
          fastcgi_pass    php-fpm-svc:9000;
          fastcgi_split_path_info ^(.+\.php)(/.+)$;
          fastcgi_index   index.php;
          include         fastcgi_params;
          include         fastcgi.conf;
        }

      ## Begin - Checks
        # php health checks
        location ~ ^/(status|ping)$ {
          access_log off;
          fastcgi_pass php-fpm-svc:9000;
          include fastcgi_params;
          #and don't serve from document_root
          fastcgi_param SCRIPT_FILENAME $fastcgi_script_name;
        }

        location /proxy_status {
          stub_status on;
          access_log   off;
        }
      ## End - Checks

      ## Begin - Security
        # deny all direct access for these folders
        location ~* /(.git|cache|bin|logs|backups|tests)/.*$ { return 403; }
        # deny running scripts inside core system folders
        location ~* /(system|vendor)/.*\.(txt|xml|md|html|yaml|php|pl|py|cgi|twig|sh|bat)$ { return 403; }
        # deny running scripts inside user folder
        location ~* /user/.*\.(txt|md|yaml|php|pl|py|cgi|twig|sh|bat)$ { return 403; }
        # deny access to specific files in the root folder
        location ~ /(LICENSE.txt|composer.lock|composer.json|nginx.conf|web.config|htaccess.txt|\.htaccess) { return 403; }
      ## End - Security
      }
    }
